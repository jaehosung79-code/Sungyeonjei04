<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì—°ì œ ìš´ë™ ì²´í¬ ì•±</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2a7bff">
<link rel="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="icon-192.png">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
body{font-family:sans-serif;padding:15px;background:#000;color:#e0e0e0;}
h2,h3{text-align:center;color:#fff;}
.container{background:#1e1e1e;padding:15px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.5);margin-bottom:15px;}
.save-btn,.delete-btn,.add-btn{padding:10px 15px;font-size:14px;border:none;border-radius:8px;cursor:pointer;}
.save-btn{background:#2a7bff;color:white;width:100%;margin-top:15px;}
.delete-btn{background:#d9534f;color:white;}
.add-btn{background:#ff9800;color:white;}
.date-row{display:flex;align-items:center;gap:8px;}
.date-row input[type="text"]{flex:1;padding:8px;font-size:16px;background:#2c2c2c;color:#e0e0e0;border:1px solid #555;border-radius:5px;}
table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;border:1px solid #555;border-radius:10px;overflow:hidden;background:#1e1e1e;}
th,td{border:1px solid #555;padding:8px;text-align:center;}
th{background:#333;color:white;}
tr.draggable-row{cursor:move;}
tr.dragging{opacity:0.3;}
input[type="checkbox"]{width:18px;height:18px;}
footer{text-align:center;margin-top:20px;padding:10px;color:#888;}
#progressContainer{background:#1e1e1e;padding:15px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.5);margin-bottom:15px;}
#progressPercent{color:red;font-size:2em;font-weight:bold;}
button:hover{opacity:0.8;}
.flatpickr-calendar{background:#1e1e1e;color:#e0e0e0;border:1px solid #555;}
.flatpickr-day.selected{background:#2a7bff !important;color:#fff !important;}
.flatpickr-day.today{border-color:#2a7bff;}
.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1000;justify-content:center;align-items:center;}
.modal{background:#333;color:white;padding:20px;border-radius:10px;text-align:center;min-width:220px;box-shadow:0 4px 15px rgba(0,0,0,0.7);}
.modal button{margin-top:10px;padding:5px 12px;border:none;border-radius:5px;background:white;color:#333;cursor:pointer;}
</style>
</head>
<body>

<h2>ì—°ì œ ìš´ë™ ì²´í¬ ì•±</h2>

<!-- ================= ì§„í–‰ë¥  ================= -->
<div id="progressContainer">
<h3>ì´ë²ˆ ë‹¬ ì§„ë„ìœ¨</h3>
<p id="progressText">
ì´ë²ˆ ë‹¬ ìš´ë™í•œ ë‚ : <span id="completedDays"></span> / <span id="totalDays"></span>ì¼<br>
ì§„ë„ìœ¨: <span id="progressPercent"></span>%</p>
</div>

<!-- ================= ë‚ ì§œ + ë²„íŠ¼ ================= -->
<div class="container">
<div class="date-row">
<input type="text" id="dateInput" readonly>
<button class="delete-btn" id="deleteDayBtn">ğŸ—‘ ì‚­ì œ</button>
<button class="add-btn" id="addExerciseBtn">+ ìš´ë™ ì¶”ê°€</button>
</div>

<!-- ================= ìš´ë™ í…Œì´ë¸” ================= -->
<table id="exerciseTable">
<thead>
<tr><th>ìš´ë™</th><th>1set</th><th>2set</th><th>3set</th><th>ì‚­ì œ</th></tr>
</thead>
<tbody id="exerciseBody"></tbody>
</table>

<button id="saveBtn" class="save-btn">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
</div>

<footer>ë§Œë“  ì‚¬ëŒ : <strong>Jaeho</strong></footer>

<!-- ================= ëª¨ë‹¬ ================= -->
<div id="modalOverlay" class="modal-overlay">
<div class="modal">
<span id="modalMessage"></span><br>
<button id="modalOkBtn">í™•ì¸</button>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
/* ---------------------------------------------------
   ê³µí†µ: ëª¨ë‹¬
--------------------------------------------------- */
const modalOverlay = document.getElementById("modalOverlay");
const modalMessage = document.getElementById("modalMessage");
document.getElementById("modalOkBtn").onclick = () => modalOverlay.style.display = "none";
function alertMsg(txt){ modalMessage.textContent = txt; modalOverlay.style.display="flex"; }

/* ---------------------------------------------------
   ë°ì´í„° ëª¨ë¸: ë‚ ì§œë³„ ìš´ë™ êµ¬ì¡°
   êµ¬ì¡° í˜•íƒœ:
   {
      exercises: [
        { id:"uuid", name:"ë³´ê°•", sets:[true,false,true] },
        ...
      ]
   }
--------------------------------------------------- */
const DEFAULT_EXERCISES = [
    "ë³´ê°•", "ì½”ì–´", "í‘¸ì‰¬ì—…", "ëª¸í†µ ëŒë¦¬ê¸°", "ì•…ë ¥ê¸°", "ê³ ë¬´ì¤„ íŠœë¹™"
];

/* UUID ìƒì„± */
function uuid(){ return "xxxxxx".replace(/x/g, ()=>((Math.random()*36)|0).toString(36)); }

/* ---------------------------------------------------
   ë‚ ì§œ ì„ íƒ: flatpickr
--------------------------------------------------- */
const fp = flatpickr("#dateInput", {
    dateFormat: "Y-m-d",
    defaultDate: new Date(),
    locale:"ko",
    onChange: (dates, dateStr) => loadDay(dateStr),
    onDayCreate: (a,b,fpObj,elem)=>{
        const date = elem.dateObj.toISOString().split("T")[0];
        if(localStorage.getItem("exercise_"+date)){
            elem.classList.add("selected");
        }
    }
});

/* ---------------------------------------------------
   í…Œì´ë¸” DOM ë™ì  êµ¬ì„±
--------------------------------------------------- */
const tbody = document.getElementById("exerciseBody");

/* ìš´ë™ Row ìƒì„± */
function createRow(ex){
    const tr = document.createElement("tr");
    tr.className = "draggable-row";
    tr.draggable = true;
    tr.dataset.id = ex.id;

    let setsHTML = ex.sets.map((v,i)=> 
        `<td><input type="checkbox" data-idx="${i}" ${v?"checked":""}></td>`
    ).join("");

    tr.innerHTML = `
        <td>${ex.name}</td>
        ${setsHTML}
        <td><button class="delete-ex-btn">X</button></td>
    `;
    return tr;
}

/* í…Œì´ë¸” ë Œë” */
function renderTable(exercises){
    tbody.innerHTML = "";
    exercises.forEach(ex => tbody.appendChild(createRow(ex)));
    initDragEvents();
}

/* ---------------------------------------------------
   Drag & Drop (ìˆœì„œ ì €ì¥)
--------------------------------------------------- */
function initDragEvents(){
    const rows = tbody.querySelectorAll("tr");

    rows.forEach(row=>{
        row.addEventListener("dragstart", ()=>{
            row.classList.add("dragging");
        });
        row.addEventListener("dragend", ()=>{
            row.classList.remove("dragging");
        });
    });

    tbody.addEventListener("dragover", e=>{
        e.preventDefault();
        const dragging = document.querySelector(".dragging");
        const after = getDragAfterElement(tbody, e.clientY);
        if(!after) tbody.appendChild(dragging);
        else tbody.insertBefore(dragging, after);
    });
}

function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll("tr:not(.dragging)")];
    return els.reduce((closest,child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset < 0 && offset > closest.offset){
            return {offset, element: child};
        } else return closest;
    }, {offset: -Infinity}).element;
}

/* ---------------------------------------------------
   ì €ì¥ / ë¡œë“œ / ì‚­ì œ
--------------------------------------------------- */
function loadDay(date){
    const key = "exercise_"+date;
    const saved = JSON.parse(localStorage.getItem(key) || "null");

    if(saved){
        renderTable(saved.exercises);
    } else {
        const exList = DEFAULT_EXERCISES.map(name=>({
            id: uuid(),
            name,
            sets: [false,false,false]
        }));
        renderTable(exList);
    }
}

function saveDay(){
    const date = fp.input.value;
    const key = "exercise_"+date;

    const exercises = [...tbody.querySelectorAll("tr")].map(tr=>{
        const name = tr.children[0].textContent;
        const id = tr.dataset.id;
        const sets = [...tr.querySelectorAll("input[type=checkbox]")].map(cb=>cb.checked);
        return {id,name,sets};
    });

    // ìš´ë™ ì²´í¬ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ 'ìš´ë™í•œ ë‚ 'ë¡œ ê°„ì£¼
    const hasWorkout = exercises.some(ex => ex.sets.some(v=>v));

    localStorage.setItem(key, JSON.stringify({exercises, hasWorkout}));
    alertMsg("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    fp.redraw();
    updateProgress();
}

function deleteDay(){
    const date = fp.input.value;
    localStorage.removeItem("exercise_"+date);
    loadDay(date);
    alertMsg("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
    fp.redraw();
    updateProgress();
}

/* ---------------------------------------------------
   ìš´ë™ ì¶”ê°€/ì‚­ì œ
--------------------------------------------------- */
document.getElementById("addExerciseBtn").onclick = ()=>{
    const name = prompt("ì¶”ê°€í•  ìš´ë™ ì´ë¦„:");
    if(!name) return;

    const newEx = { id: uuid(), name, sets:[false,false,false] };
    tbody.appendChild(createRow(newEx));
    initDragEvents();
};

/* ì‚­ì œ ë²„íŠ¼ (Event Delegation) */
tbody.addEventListener("click", e=>{
    if(e.target.classList.contains("delete-ex-btn")){
        const tr = e.target.closest("tr");
        const name = tr.children[0].textContent;

        if(DEFAULT_EXERCISES.includes(name)){
            alertMsg("ê¸°ë³¸ ìš´ë™ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        tr.remove();
    }
});

/* ---------------------------------------------------
   ì›”ê°„ í†µê³„
--------------------------------------------------- */
function updateProgress(){
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth()+1;

    const days = new Date(year,month,0).getDate();
    let count = 0;

    const m = month.toString().padStart(2,"0");

    for(let i=1;i<=days;i++){
        const d = i.toString().padStart(2,"0");
        const data = JSON.parse(localStorage.getItem(`exercise_${year}-${m}-${d}`) || "null");
        if(data && data.hasWorkout) count++;
    }

    const rate = ((count/days)*100).toFixed(1);

    document.getElementById("completedDays").textContent = count;
    document.getElementById("totalDays").textContent = days;
    document.getElementById("progressPercent").textContent = rate;
}

/* ---------------------------------------------------
   ì´ë²¤íŠ¸ ë°”ì¸ë”©
--------------------------------------------------- */
document.getElementById("saveBtn").onclick = saveDay;
document.getElementById("deleteDayBtn").onclick = deleteDay;

/* ---------------------------------------------------
   ì´ˆê¸° ë¡œë“œ
--------------------------------------------------- */
loadDay(fp.input.value);
updateProgress();

/* ---------------------------------------------------
   PWA ì„œë¹„ìŠ¤ì›Œì»¤
--------------------------------------------------- */
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js')
        .then(()=>console.log("Service Worker ë“±ë¡ë¨"))
        .catch(err=>console.error("Service Worker ë“±ë¡ ì‹¤íŒ¨",err));
}

</script>
</body>
</html>
